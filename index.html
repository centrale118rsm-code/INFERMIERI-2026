<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff" id="theme-color-meta">
    <meta name="apple-mobile-web-app-title" content="Turni Infermieri">
    <meta name="description" content="Gestione Turni Infermieri 2026">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    
    <title>TURNI INFERMIERI 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- STILE ORIGINALE TURNI AUTISTI --- */
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; outline: none; }
        
        :root {
            --primary: #2563eb; 
            --bg: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --header-bg: rgba(255, 255, 255, 0.92);
            
            --header-h: 155px;        
            --cell-h: 60px;                
            --font-base: 0.85rem;        
            --font-small: 0.7rem;        
            --th-h: 40px;                
            
            /* COLORI TURNI (Base) */
            --c-M: #026bfe; --t-M: #ffffff; --b-M: #bae6fd;
            --c-P: #56a2ff; --t-P: #ffffff; --b-P: #c7d2fe;
            --c-N: #003785; --t-N: #ffffff; --b-N: #c7d2fe;
            --c-R: #ecfdf5; --t-R: #059669; --b-R: #6ee7b7;
            --c-SM: #10004f; --t-SM: #ffffff; --b-SM: #cbd5e1;

            /* Specifici Richiesti */
            --bg-ferie: #ff782ff6; --t-ferie: #ffffff; --b-ferie: #a15300; /* v */
            --bg-rec: #d00173; --t-rec: #ffe8f2; --b-rec: #c3006b; /* r */
            --bg-cong: #ffea00; --t-cong: #000000; --b-cong: #fbff00; /* f */
            --bg-mal: #ef4444; --t-mal: #ffffff; --b-mal: #b91c1c; /* m */
            --bg-nl: #e0f7fa; --t-nl: #006064; --b-nl: #b2ebf2; /* nl */
            --bg-perm: #00e749; --t-perm: #000000; --b-perm: #004e1c; /* p */
            --bg-ng: #00bfff; --t-ng: #ffffff; --b-ng: #0099cc; /* ng */
            --bg-stu: #3b82f6; --t-stu: #ffffff; --b-stu: #1d4ed8; /* c */

            --month-bar-bg: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode {
            --bg: #0f172a; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --text-sec: #94a3b8; 
            --border: #334155; 
            --header-bg: rgba(15, 23, 42, 0.95);
            --theme-color: #0f172a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); margin: 0; padding-top: var(--header-h); 
            color: var(--text-main); transition: background 0.3s ease, color 0.3s ease; 
            overscroll-behavior-y: none; 
        }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--header-bg); 
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
            z-index: 1000; height: var(--header-h);
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .top-bar { padding: 0 16px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; }
        .logo { font-size: 1.15rem; font-weight: 900; color: var(--text-main); display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .logo img { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); border-radius: 8px; cursor: pointer; }
        .logo img:active { transform: scale(0.9); }
        
        .right-controls { display: flex; gap: 8px; position: relative; }

        .btn-action { 
            background: var(--bg-card); color: var(--text-sec); border: 1px solid var(--border); 
            width: 42px; height: 42px; padding: 0; 
            border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .btn-action span { font-size: 1.5rem; }
        .btn-action:active { transform: scale(0.94); opacity: 0.8; }
        
        .badge-dot {
            position: absolute; top: 8px; right: 8px;
            width: 10px; height: 10px; background: #ef4444;
            border-radius: 50%; border: 2px solid var(--bg-card);
            display: none; 
        }
        .badge-dot.visible { display: block; }

        #menu-dropdown { 
            position: absolute; top: 55px; right: 0; background: var(--bg-card); 
            border-radius: 16px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); 
            width: 220px; overflow: hidden; display: none; border: 1px solid var(--border); 
            flex-direction: column; z-index: 5000; transform-origin: top right;
        }
        #menu-dropdown.open { display: flex; animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .menu-item { padding: 16px 20px; display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--text-main); border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: var(--bg); }
        .menu-item span { color: var(--primary); }
        
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .nav-scroller, .driver-scroller { flex: 1; display: flex; gap: 8px; overflow-x: auto; padding: 0 16px; align-items: center; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .nav-scroller { border-bottom: 1px solid var(--border); }
        
        .chip { 
            padding: 8px 16px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s ease; 
            display: flex; align-items: center; justify-content: center;
        }
        
        .chip-month { background: var(--bg-card); color: var(--text-sec); border: 1px solid var(--border); }
        .chip-month.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); transform: translateY(-1px); }
        
        .chip-driver { background: var(--bg); color: var(--text-sec); border: 1px solid var(--border); }
        .chip-driver.active { background: var(--text-main); color: var(--bg-card); border-color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-1px); }

        .container { padding: 0; max-width: 100%; margin: 0 auto; padding-bottom: 80px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }

        thead th {
            background: var(--bg); color: var(--text-sec); padding: 5px; font-size: 0.7rem; 
            text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px;
            position: sticky; top: var(--header-h); z-index: 90; 
            border-bottom: 1px solid var(--border); text-align: center; min-width: 115px;
            height: var(--th-h); backdrop-filter: blur(5px);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        thead th:first-child, .td-date { width: 60px !important; min-width: 60px !important; max-width: 60px !important; }

        tr.month-header td {
            background: var(--month-bar-bg);
            color: white; 
            position: sticky; top: calc(var(--header-h) + var(--th-h)); z-index: 85; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            padding: 0; 
            border: none;
            line-height: 1;
        }
        .sticky-month-text { 
            position: sticky; left: 0; width: 100vw; 
            text-align: left; 
            padding: 4px 0 4px 16px; 
            display: flex; 
            align-items: center;
            gap: 12px;
            min-height: 40px;
        }
        .month-label { font-weight: 900; font-size: 1.4rem; text-transform: uppercase; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .live-clock { font-variant-numeric: tabular-nums; font-weight: 800; font-size: 1rem; background: rgba(0,0,0,0.25); padding: 2px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); letter-spacing: 0.5px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        tbody td { 
            padding: 2px; height: var(--cell-h); vertical-align: middle; 
            border-bottom: 1px solid var(--border); border-right: 1px dashed var(--border); 
            transition: height 0.3s ease;
        }
        
        .td-date { 
            text-align: center; font-weight: 800; color: var(--text-main); font-size: 1.1rem; 
            border-right: 2px solid var(--border); background: var(--bg);
            position: sticky; left: 0; z-index: 80;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: var(--cell-h); 
        }
        .td-date small { display: block; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); margin-top: 2px; }
        .td-date.date-red { color: #dc2626; background: #fef2f2; border-right-color: #fca5a5; }
        .td-date.date-red small { color: #ef4444; }
        body.dark-mode .td-date.date-red { background: #450a0a; color: #fca5a5; border-right-color: #7f1d1d; }
        body.dark-mode .td-date.date-red small { color: #fecaca; }

        .holiday-name { font-size: 0.55rem; color: #dc2626; font-weight: 900; line-height: 1; margin-top: 3px; max-width: 55px; white-space: normal; }
        body.dark-mode .holiday-name { color: #f87171; }

        .cell { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100%; width: 100%; border-radius: 10px; font-weight: 800; 
            font-size: var(--font-base); text-transform: uppercase; position: relative; 
            line-height: 1.1; text-align: center; cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.1s;
            padding-bottom: 2px; 
        }
        .cell:active { transform: scale(0.96); }
        body.dark-mode .cell.empty { color: #475569; }
        body.dark-mode .cell { box-shadow: none; border: 1px solid rgba(255,255,255,0.05); }

        .time-tag { font-size: var(--font-small); font-weight: 600; opacity: 0.85; margin-top: 1px; letter-spacing: -0.3px; }
        
        .rep-badge { 
            font-size: 0.55rem; color: #ffffff; margin-top: 1px; font-weight: 900; 
            background: linear-gradient(135deg, #ef4444, #dc2626); padding: 1px 6px; 
            border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); letter-spacing: 0.5px; 
            line-height: 1; white-space: nowrap;
        }

        /* STILI TURNI */
        .t-M { background: var(--c-M); color: var(--t-M); border: 1px solid var(--b-M); }
        .t-P { background: var(--c-P); color: var(--t-P); border: 1px solid var(--b-P); }
        .t-N { background: var(--c-N); color: var(--t-N); border: 1px solid var(--b-N); }
        .t-R { background: var(--c-R); color: var(--t-R); border: 1px solid var(--b-R); }
        .t-S { background: var(--c-SM); color: var(--t-SM); border: 1px solid var(--b-SM); }
        
        /* STILI SPECIALI RICHIESTI */
        .spec-ferie { background: var(--bg-ferie); color: var(--t-ferie); border: 1px solid var(--b-ferie); font-size: 0.65rem; }
        .spec-rec { background: var(--bg-rec); color: var(--t-rec); border: 1px solid var(--b-rec); font-size: 0.65rem; }
        .spec-cong { background: var(--bg-cong); color: var(--t-cong); border: 1px solid var(--b-cong); font-size: 0.65rem; }
        .spec-mal { background: var(--bg-mal); color: var(--t-mal); border: 1px solid var(--b-mal); font-size: 0.75rem; }
        .spec-nl { background: var(--bg-nl); color: var(--t-nl); border: 1px solid var(--b-nl); font-size: 0.65rem; }
        .spec-perm { background: var(--bg-perm); color: var(--t-perm); border: 1px solid var(--b-perm); font-size: 0.65rem; }
        .spec-ng { background: var(--bg-ng); color: var(--t-ng); border: 1px solid var(--b-ng); font-size: 0.65rem; }
        .spec-stu { background: var(--bg-stu); color: var(--t-stu); border: 1px solid var(--b-stu); font-size: 0.65rem; }

        .empty { background: transparent; box-shadow: none; color: #cbd5e1; font-weight: 400;}

        tr.today td { background: #fff7ed !important; border-bottom: 2px solid #f97316 !important; }
        tr.today .td-date { color: #ea580c; border-left: 6px solid #ea580c; background: #fff7ed; border-right: 2px solid #f97316; }
        body.dark-mode tr.today td { background: #431407 !important; border-bottom: 2px solid #ea580c !important; }
        body.dark-mode tr.today .td-date { background: #431407; color: #fdba74; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px;}
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #manual-upload { display: none; margin-top: 20px; animation: fadeIn 0.5s ease; }
        .file-label { background: var(--primary); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; box-shadow: 0 4px 15px rgba(37,99,235,0.4); transition: transform 0.2s; }
        .file-label:active { transform: scale(0.96); }
        input[type="file"] { display: none; }
        
        /* MODALE GENERICO */
        #shift-modal, #dinner-modal, #options-modal, #notif-center-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 3000; backdrop-filter: blur(8px); align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #shift-modal.open, #dinner-modal.open, #options-modal.open, #notif-center-modal.open { opacity: 1; }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; display: flex; flex-direction: column; }
        #shift-modal.open .modal-content, #dinner-modal.open .modal-content, #options-modal.open .modal-content, #notif-center-modal.open .modal-content { transform: translateY(0); }
        
        .modal-header { background: var(--bg); color: var(--text-main); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .header-text h3 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px;}
        .header-text span { display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); margin-top: 4px;}
        
        .btn-close-modal { background: var(--bg); border: none; color: var(--text-sec); cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .colleague-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .c-name { font-weight: 700; color: var(--text-main); font-size: 1rem; }
        .c-time { font-size: 0.8rem; font-weight: 600; color: var(--text-sec); background: var(--bg); padding: 6px 12px; border-radius: 8px; font-variant-numeric: tabular-nums; }
        
        /* Modal Themes */
        .modal-theme-M .modal-header { background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); } .modal-theme-M .header-text h3 { color: #0c4a6e; } .modal-theme-M .c-time { background: #e0f2fe; color: #0369a1; }
        .modal-theme-P .modal-header { background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); } .modal-theme-P .header-text h3 { color: #312e81; } .modal-theme-P .c-time { background: #e0e7ff; color: #4338ca; }
        .modal-theme-N .modal-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); } .modal-theme-N .header-text h3 { color: white; } .modal-theme-N .header-text span { color: #94a3b8; } .modal-theme-N .btn-close-modal { background: #334155; color: white; } .modal-theme-N .c-time { background: #f1f5f9; color: #0f172a; }
        .modal-theme-R .modal-header { background: linear-gradient(135deg, #dcfce7 0%, #ecfdf5 100%); } .modal-theme-R .header-text h3 { color: #064e3b; } .modal-theme-R .c-time { background: #dcfce7; color: #15803d; }
        .modal-theme-SM .modal-header { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); } .modal-theme-SM .header-text h3 { color: white; }

        /* OPTIONS MODAL SPECIFIC */
        .option-item { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-main); }
        .option-item:last-child { border-bottom: none; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* NOTIFICATION CENTER SPECIFIC */
        .notif-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .notif-item { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; position: relative; transition: all 0.2s; }
        .notif-item.unread { border-left: 4px solid var(--primary); background: #f0f9ff; }
        body.dark-mode .notif-item.unread { background: #1e293b; border-color: #334155; border-left-color: var(--primary); }
        .notif-date { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 4px; font-weight: 600; }
        .notif-text { font-size: 0.9rem; color: var(--text-main); line-height: 1.4; }
        .btn-del-notif { position: absolute; top: 10px; right: 10px; color: #ef4444; background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; }
        .btn-del-notif:active { background: rgba(239, 68, 68, 0.1); }
        .no-notif { text-align: center; padding: 40px 20px; color: var(--text-sec); font-size: 0.9rem; }

        .btn-install { background: var(--text-main); color: var(--bg); border: none; padding: 10px 18px; border-radius: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-install:active { transform: scale(0.96); }

        /* MODALE CENA */
        .dinner-checkbox-list { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dinner-check-item { background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-sec); transition: all 0.2s; }
        .dinner-check-item.checked { background: var(--bg); border-color: var(--primary); color: var(--primary); box-shadow: 0 2px 4px rgba(37,99,235,0.1); }
        .dinner-check-item input { display: none; }
        .dinner-check-icon { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .dinner-check-item.checked .dinner-check-icon { background: var(--primary); border-color: var(--primary); color: white; }
        .dinner-section-title { font-size: 0.75rem; font-weight: 800; color: var(--text-sec); padding: 20px 20px 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .month-selector { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 10px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .btn-find-dinner { margin: 20px; background: #0f172a; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 800; font-size: 1rem; width: calc(100% - 40px); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); transition: 0.2s; }
        body.dark-mode .btn-find-dinner { background: var(--primary); }
        .event-type-selector { display: flex; background: var(--bg); padding: 4px; border-radius: 14px; margin: 0 20px 10px; }
        .event-option { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; color: var(--text-sec); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .event-option.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .dinner-result-card { background: var(--bg-card); margin: 10px 20px; padding: 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); }
        .d-res-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px; }
        .d-res-date { font-weight: 800; font-size: 1.1rem; color: var(--text-main); text-transform: capitalize; }
        .d-res-score { background: #dcfce7; color: #15803d; font-weight: 700; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
        .missing-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .missing-badge { background: #fee2e2; color: #b91c1c; font-size: 0.75rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
        .warning-badge { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; display:inline-flex; align-items:center; gap:4px; }

        /* MODALE STATISTICHE */
        #stats-modal { display: none; position: fixed; inset: 0; background: var(--bg-card); z-index: 4000; flex-direction: column; overflow: hidden; animation: slideInRight 0.3s ease; }
        #stats-modal.open { display: flex; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .stats-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .stats-body { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); -webkit-overflow-scrolling: touch; }
        .driver-list-item { padding: 18px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text-main); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); margin-bottom: 10px; border-radius: 14px; box-shadow: var(--shadow-soft); transition: 0.2s; }
        .driver-list-item:active { transform: scale(0.98); background: var(--bg); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 10px; }
        .stat-card { background: var(--bg-card); padding: 16px; border-radius: 18px; border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow-soft); display:flex; flex-direction:column; justify-content:center; }
        .stat-val { font-size: 2rem; font-weight: 900; display: block; margin-bottom: 4px; line-height: 1; letter-spacing: -1px; color: var(--text-main); }
        .stat-lbl { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-sec); }
        
        .sc-fer { color: var(--b-ferie); border-color: var(--bg-ferie); background: #fff7ed; }
        .sc-cong { color: var(--b-cong); border-color: var(--bg-cong); background: #fefce8; }
        .sc-perm { color: var(--b-perm); border-color: var(--bg-perm); background: #f0fdf4; }
        .sc-mal { color: #b91c1c; border-color: #fca5a5; background: #fef2f2; }
        .sc-fest { color: #0369a1; border-color: #7dd3fc; background: #f0f9ff; }
        .sc-rec { color: var(--b-rec); border-color: var(--bg-rec); background: #fdf2f8; }
        
        /* MODALE AVVISI */
        #alert-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; padding: 20px; }
        #alert-modal.open { opacity: 1; }
        .alert-card { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); overflow: hidden; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid var(--border); }
        #alert-modal.open .alert-card { transform: scale(1); }
        .alert-header { padding: 20px 24px; display: flex; align-items: center; gap: 15px; background: #fff7ed; border-bottom: 1px solid #ffedd5; }
        .alert-icon-box { width: 45px; height: 45px; border-radius: 12px; background: #fffbeb; display: flex; align-items: center; justify-content: center; color: #d97706; border: 1px solid #fcd34d; flex-shrink: 0; }
        .alert-title { font-weight: 800; font-size: 1.1rem; color: #92400e; line-height: 1.2; }
        .alert-body { padding: 24px; font-size: 1rem; color: var(--text-main); line-height: 1.5; }
        .alert-footer { padding: 0 24px 24px; }
        .btn-alert-ok { width: 100%; padding: 14px; border-radius: 14px; border: none; background: #d97706; color: white; font-weight: 800; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-alert-ok:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div id="alert-modal">
        <div class="alert-card">
            <div class="alert-header">
                <div class="alert-icon-box">
                    <span class="material-icons-round" style="font-size: 28px;">notifications_active</span>
                </div>
                <div class="alert-title" id="alert-title-text">AVVISO</div>
            </div>
            <div class="alert-body" id="alert-message-text">Contenuto avviso...</div>
            <div class="alert-footer">
                <button class="btn-alert-ok" onclick="closeAlertAndSave()">
                    <span class="material-icons-round">done</span> HO CAPITO
                </button>
            </div>
        </div>
    </div>

    <div id="notif-center-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="header-text">
                    <h3><span class="material-icons-round" style="margin-right:10px">notifications</span> NOTIFICHE</h3>
                    <span>Storico Avvisi</span>
                </div>
                <div style="display:flex; gap:10px">
                    <button class="btn-close-modal" onclick="clearAllNotif()" style="color:#ef4444">
                        <span class="material-icons-round">delete_sweep</span>
                    </button>
                    <button class="btn-close-modal" onclick="closeNotifCenter()">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body notif-list" id="notif-list-container"></div>
        </div>
    </div>

    <div id="loader">
        <div id="auto-loader">
            <div class="spinner"></div>
            <h3 style="color:var(--text-main); margin:0; font-size:1.1rem; font-weight:800">Inizializzazione...</h3>
            <p style="color:var(--text-sec); font-size:0.85rem; margin-top:8px">Lettura Turni 2026</p>
        </div>
        <div id="manual-upload">
            <p style="color:#ef4444; font-weight:bold; font-size:1.1rem; margin-bottom:10px">⚠️ File automatico non trovato</p>
            <p style="color:var(--text-sec); font-size:0.9rem; margin:0">Carica file Excel (turni.xlsx)</p>
            <label for="file-input" class="file-label">
                <span class="material-icons-round">upload_file</span>
                CARICA FILE (.xlsx)
            </label>
            <input type="file" id="file-input" accept=".xlsx">
        </div>
    </div>

    <div id="shift-modal" onclick="closeShiftModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header" id="modal-header-bg">
                <div class="header-text">
                    <h3 id="modal-title">TITOLO</h3>
                    <span id="modal-subtitle">Data del giorno</span>
                </div>
                <button class="btn-close-modal" onclick="closeShiftModal()">
                    <span class="material-icons-round">keyboard_arrow_down</span>
                </button>
            </div>
            <div class="modal-body" id="modal-list"></div>
        </div>
    </div>
    
    <div id="options-modal" onclick="closeOptionsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="header-text">
                    <h3><span class="material-icons-round" style="margin-right:10px">settings</span> OPZIONI</h3>
                    <span>Impostazioni App</span>
                </div>
                <button class="btn-close-modal" onclick="closeOptionsModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding:0">
                <div class="option-item" style="display:block">
                    <div style="margin-bottom:10px">
                        <span style="font-size:1rem; font-weight:700">Monitoraggio Turni</span>
                        <div style="font-size:0.8rem; color:var(--text-sec)">Seleziona chi seguire.</div>
                    </div>
                    <div id="notification-driver-list" class="dinner-checkbox-list" style="padding:0; grid-template-columns: 1fr 1fr;"></div>
                </div>
                <div class="option-item" id="install-container">
                    <div style="display:flex; flex-direction:column">
                        <span style="font-size:1rem">Installa Applicazione</span>
                        <span style="font-size:0.8rem; color:var(--text-sec); font-weight:400">Aggiungi a schermata Home</span>
                    </div>
                    <button class="btn-install" id="btn-install-pwa" onclick="installPWA()">
                        <span class="material-icons-round">install_mobile</span> INSTALLA
                    </button>
                </div>
                <div class="option-item">
                    <div style="display:flex; flex-direction:column">
                        <span style="font-size:1rem">Tema Scuro</span>
                        <span style="font-size:0.8rem; color:var(--text-sec); font-weight:400">Riduci affaticamento occhi</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div id="dinner-modal" onclick="closeDinnerModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="height:90vh; max-height:90vh;">
            <div class="modal-header" style="background:#fff7ed; border-bottom-color:#ffedd5;">
                <div class="header-text">
                    <h3 style="color:#ea580c"><span class="material-icons-round" style="margin-right:8px">restaurant</span> ORGANIZZA</h3>
                    <span style="color:#fb923c">Trova la data migliore</span>
                </div>
                <button class="btn-close-modal" onclick="closeDinnerModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="background:var(--bg-card); display:flex; flex-direction:column; height:100%;">
                <div id="dinner-step-1">
                    <div class="dinner-section-title">1. MESE</div>
                    <div class="month-selector" id="dinner-month-list"></div>
                    <div class="dinner-section-title">2. TIPO DI USCITA</div>
                    <div class="event-type-selector">
                        <div class="event-option active" id="opt-cena" onclick="setEventType('cena', this)">
                            <span class="material-icons-round">bedtime</span> CENA (Sera)
                        </div>
                        <div class="event-option" id="opt-pranzo" onclick="setEventType('pranzo', this)">
                            <span class="material-icons-round">wb_sunny</span> PRANZO (Giorno)
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right:20px;">
                        <div class="dinner-section-title">3. SELEZIONA COLLEGHI</div>
                        <button onclick="toggleAllDrivers()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; font-size:0.8rem; padding:10px;">Tutti/Nessuno</button>
                    </div>
                    <div class="dinner-checkbox-list" id="dinner-driver-list"></div>
                    <div style="padding:0 20px 20px 20px;">
                        <button class="btn-find-dinner" onclick="calculateDinner()">
                            <span class="material-icons-round">search</span> CERCA DISPONIBILITÀ
                        </button>
                    </div>
                </div>
                <div id="dinner-step-2" style="display:none; padding-bottom:30px;">
                    <div style="padding:15px 20px; display:flex; align-items:center; gap:10px; cursor:pointer; color:var(--primary); font-weight:700" onclick="resetDinnerStep()">
                        <span class="material-icons-round">arrow_back</span> Torna ai filtri
                    </div>
                    <div id="dinner-results-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-modal">
        <div class="stats-header">
            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main); display:flex; align-items:center; gap:10px;">
                <span class="material-icons-round">bar_chart</span> STATISTICHE
            </h3>
            <button class="btn-close-modal" onclick="closeStatsModal()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="stats-body" id="stats-container"></div>
    </div>

    <header>
        <div class="top-bar">
            <div class="logo">
                <img src="logo.png" style="height: 40px; width: auto; display:block;" alt="Logo" onerror="this.style.display='none'">
                <div style="display:flex; flex-direction:column; line-height:1;">
                    <span>TURNI INFERMIERI</span>
                    <span id="last-update-badge" style="font-size:0.65rem; font-weight:500; color:var(--text-sec); margin-top:4px;"></span>
                </div>
            </div>
            <div class="right-controls">
                <button class="btn-action" onclick="vibrate(); scrollToToday()">
                    <span class="material-icons-round">home</span>
                </button>
                <button class="btn-action" onclick="openNotifCenter()" style="position:relative">
                    <span class="material-icons-round">notifications</span>
                    <span id="notif-badge" class="badge-dot"></span>
                </button>
                <button class="btn-action" onclick="toggleMenu()">
                    <span class="material-icons-round">more_vert</span>
                </button>
                <div id="menu-dropdown">
                    <div class="menu-item" onclick="openDinnerModal()">
                        <span class="material-icons-round">restaurant</span> Organizza Uscita
                    </div>
                    <div class="menu-item" onclick="openStatsSelection()">
                        <span class="material-icons-round">bar_chart</span> Statistiche
                    </div>
                     <div class="menu-item" onclick="openOptionsModal()">
                        <span class="material-icons-round">settings</span> Opzioni
                    </div>
                    <div class="menu-item" onclick="vibrate(); location.reload()">
                        <span class="material-icons-round">refresh</span> Aggiorna
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-scroller" id="month-nav"></div>
        <div class="driver-scroller" id="driver-nav"></div>
    </header>

    <div class="container">
        <table id="main-table">
            <thead><tr id="table-head"></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        const FILE_NAME = "turni.xlsx?v=" + new Date().getTime(); 
        const MONTH_MAP = { "GENNAIO":0, "FEBBRAIO":1, "MARZO":2, "APRILE":3, "MAGGIO":4, "GIUGNO":5, "LUGLIO":6, "AGOSTO":7, "SETTEMBRE":8, "OTTOBRE":9, "NOVEMBRE":10, "DICEMBRE":11 };
        const HOLIDAYS = {
            "0-1": "CAPODANNO", "0-6": "EPIFANIA", "1-5": "S. AGATA", "2-25": "ARENGO", "3-1": "REGGENZA", "3-5": "PASQUA", "3-6": "LUN. ANGELO", "4-1": "1° MAGGIO", "5-4": "CORPUS DOM.", "6-28": "LIBERAZIONE", "7-15": "FERRAGOSTO", "8-3": "S. MARINO", "9-1": "REGGENZA", "10-1": "OGNISSANTI", "10-2": "COMM. DEFUNTI", "11-8": "IMMACOLATA", "11-25": "NATALE", "11-26": "S. STEFANO"
        };
        const SCHEDULE = { 
            "M": "07:00-14:00", 
            "P": "14:00-21:00", 
            "N": "21:00-07:00", 
            "SM": "00:00-7:20", 
            "R": "RIPOSO" 
        };

        let finalData = [];
        let drivers = [];
        let selectedDrivers = new Set();
        let watchedDrivers = new Set();
        let notifHistory = []; 
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        function installPWA() {
            if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((c) => { deferredPrompt = null; }); } 
            else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if(isIOS) alert("Su iPhone: tocca 'Condividi' e 'Aggiungi alla schermata Home'."); else alert("Usa il menu del browser per installare l'app."); }
        }

        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('#theme-color-meta').setAttribute('content', '#0f172a');
            window.addEventListener('load', () => { if(document.getElementById('dark-mode-toggle')) document.getElementById('dark-mode-toggle').checked = true; });
        }

        function vibrate() { if(navigator.vibrate) navigator.vibrate(10); }

        function toggleMenu() {
            vibrate(); let m = document.getElementById('menu-dropdown');
            if(m.style.display === 'flex') { m.classList.remove('open'); setTimeout(() => m.style.display = 'none', 100); } 
            else { m.style.display = 'flex'; setTimeout(() => m.classList.add('open'), 10); }
        }
        
        function openOptionsModal() {
            toggleMenu(); let m = document.getElementById('options-modal'); m.style.display = 'flex'; setTimeout(() => m.classList.add('open'), 10);
            const tg = document.getElementById('dark-mode-toggle'); if(tg) tg.checked = document.body.classList.contains('dark-mode');
        }
        function closeOptionsModal(e) { if (e && e.target !== e.currentTarget) return; let m = document.getElementById('options-modal'); m.classList.remove('open'); setTimeout(() => m.style.display = 'none', 200); }

        function toggleDarkMode() {
            vibrate(); document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('#theme-color-meta').setAttribute('content', isDark ? '#0f172a' : '#ffffff');
        }

        document.addEventListener('click', function(event) {
            let m = document.getElementById('menu-dropdown'); let btn = document.querySelector('.btn-action[onclick="toggleMenu()"]');
            if (m.style.display === 'flex' && !m.contains(event.target) && !btn.contains(event.target)) toggleMenu();
        });

        window.onload = async () => {
            try { const lastUp = new Date(document.lastModified); document.getElementById('last-update-badge').innerText = `Agg. ${lastUp.toLocaleDateString()} ${lastUp.toLocaleTimeString().slice(0,5)}`; } catch(e) {}
            try { const response = await fetch(FILE_NAME); if (!response.ok) throw new Error("File mancante"); const buffer = await response.arrayBuffer(); loadWorkbook(buffer); } 
            catch (e) { console.error(e); document.getElementById('auto-loader').style.display = 'none'; document.getElementById('manual-upload').style.display = 'block'; }
        };

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (evt) => loadWorkbook(evt.target.result); reader.readAsArrayBuffer(file);
        });

        async function loadWorkbook(buffer) {
            try {
                const workbook = new ExcelJS.Workbook(); await workbook.xlsx.load(buffer);
                let ws = workbook.worksheets[0]; let rawData = [];
                ws.eachRow({ includeEmpty: true }, (row, rowNumber) => {
                    let rowData = [];
                    row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                        let val = cell.value;
                        if(typeof val === 'object' && val !== null) val = val.result || val.richText?.[0]?.text || "";
                        rowData[colNumber] = { v: val };
                    });
                    rawData[rowNumber] = rowData;
                });
                finalData = parseHorizontalLayout(rawData);
                document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                initApp();
            } catch(e) { alert("Errore file: " + e.message); }
        }

        function parseHorizontalLayout(raw) {
            let processed = []; let daysRowIdx = -1;
            for(let r=1; r<raw.length; r++) {
                if(raw[r]) {
                    let countNums = 0;
                    for(let c=1; c<raw[r].length; c++) if(raw[r][c] && !isNaN(parseInt(raw[r][c].v)) && parseInt(raw[r][c].v) > 0) countNums++;
                    if(countNums > 20) { daysRowIdx = r; break; }
                }
            }
            if(daysRowIdx === -1) throw new Error("Riga giorni non trovata");

            let nurseRows = []; let seenNames = new Set(); 
            for(let r = daysRowIdx + 1; r < raw.length; r++) {
                if(raw[r] && raw[r][1] && typeof raw[r][1].v === 'string' && raw[r][1].v.length > 2) {
                    let n = raw[r][1].v.trim().toUpperCase();
                    if(n === "NAN" || seenNames.has(n)) continue; 
                    seenNames.add(n); nurseRows.push({ name: n, idx: r, subIdx: r + 1 });
                }
            }

            let headerRow = ["MESE", "GIORNO", "NOME"]; nurseRows.forEach(n => headerRow.push(n.name)); processed.push(headerRow);
            let currentMonth = "GENNAIO"; let daysRow = raw[daysRowIdx]; let monthRow = raw[1]; 

            for(let c = 2; c < daysRow.length; c++) {
                if(monthRow && monthRow[c] && typeof monthRow[c].v === 'string') {
                    let txt = monthRow[c].v.toUpperCase(); let pureMonth = txt.replace(/[^A-Z]/g, ''); 
                    if(MONTH_MAP[pureMonth] !== undefined) currentMonth = pureMonth;
                    else if(txt.includes("GENNAIO")) currentMonth = "GENNAIO";
                    else if(txt.includes("FEBBRAIO")) currentMonth = "FEBBRAIO";
                    else if(txt.includes("MARZO")) currentMonth = "MARZO";
                    else if(txt.includes("APRILE")) currentMonth = "APRILE";
                    else if(txt.includes("MAGGIO")) currentMonth = "MAGGIO";
                    else if(txt.includes("GIUGNO")) currentMonth = "GIUGNO";
                    else if(txt.includes("LUGLIO")) currentMonth = "LUGLIO";
                    else if(txt.includes("AGOSTO")) currentMonth = "AGOSTO";
                    else if(txt.includes("SETTEMBRE")) currentMonth = "SETTEMBRE";
                    else if(txt.includes("OTTOBRE")) currentMonth = "OTTOBRE";
                    else if(txt.includes("NOVEMBRE")) currentMonth = "NOVEMBRE";
                    else if(txt.includes("DICEMBRE")) currentMonth = "DICEMBRE";
                }
                if(!daysRow[c]) continue;
                let dayVal = parseInt(daysRow[c].v); if(isNaN(dayVal) || dayVal === 0) continue;

                let dataRow = [{v: currentMonth}, {v: dayVal}, {v: ""}];
                nurseRows.forEach(nurse => {
                    let cellMain = raw[nurse.idx][c] || {v: ""};
                    let cellSub = (raw[nurse.subIdx] && raw[nurse.subIdx][c]) ? raw[nurse.subIdx][c] : {v: ""};
                    dataRow.push({ v: cellMain.v, subV: cellSub.v });
                });
                processed.push(dataRow);
            }
            return processed;
        }

        function initApp() {
            let header = finalData[0]; drivers = [];
            for(let i=3; i<header.length; i++) drivers.push({name: header[i], idx: i});
            const drvNav = document.getElementById('driver-nav'); drvNav.innerHTML = "";
            let btnAll = document.createElement('div'); btnAll.className = "chip chip-driver active"; btnAll.innerText = "TUTTI";
            btnAll.dataset.idx = "all"; btnAll.onclick = () => filterDriver("all", btnAll); drvNav.appendChild(btnAll);
            drivers.forEach(d => {
                let btn = document.createElement('div'); btn.className = "chip chip-driver"; btn.innerText = d.name;
                btn.dataset.idx = d.idx; btn.onclick = () => filterDriver(d.idx, btn); drvNav.appendChild(btn);
            });
            
            let savedDr = localStorage.getItem("selected_nurses");
            if(savedDr) { try { const savedArr = JSON.parse(savedDr); if(Array.isArray(savedArr)) { selectedDrivers = new Set(savedArr); updateDriverButtons(); } } catch(e) {} }

            initNotificationOptions(); loadNotificationHistory(); renderTable(); startLiveClock(); setTimeout(scrollToToday, 600); setTimeout(checkForScheduleChanges, 2000);
        }

        /* --- NOTIFICHE E MONITORAGGIO --- */
        function initNotificationOptions() {
            const list = document.getElementById('notification-driver-list'); if(!list) return; list.innerHTML = "";
            const saved = localStorage.getItem('watched_nurses_ids'); if(saved) watchedDrivers = new Set(JSON.parse(saved));
            drivers.forEach(d => {
                let isChecked = watchedDrivers.has(d.idx) ? "checked" : "";
                let item = document.createElement('label'); item.className = `dinner-check-item ${isChecked}`;
                item.innerHTML = `<input type="checkbox" value="${d.idx}" ${isChecked ? "checked" : ""} onchange="toggleWatchDriver(${d.idx}, this)"><div class="dinner-check-icon"><span class="material-icons-round" style="font-size:14px">notifications</span></div>${d.name}`;
                list.appendChild(item);
            });
        }
        function toggleWatchDriver(idx, el) {
            vibrate(); if(watchedDrivers.has(idx)) { watchedDrivers.delete(idx); el.parentElement.classList.remove('checked'); } else { watchedDrivers.add(idx); el.parentElement.classList.add('checked'); }
            localStorage.setItem('watched_nurses_ids', JSON.stringify([...watchedDrivers]));
        }
        function checkForScheduleChanges() {
            if(watchedDrivers.size === 0) return;
            let currentSnapshot = {};
            for(let i=1; i<finalData.length; i++) {
                let row = finalData[i]; let month = row[0].v; let day = row[1].v; if(!day || !month) continue;
                let dateKey = `${month}-${day}`; 
                watchedDrivers.forEach(dIdx => {
                    let cell = row[dIdx]; let val = cell.v ? cell.v.toString().trim() : "";
                    currentSnapshot[`${dateKey}-DRV${dIdx}`] = val;
                });
            }
            let oldJson = localStorage.getItem('nurse_schedule_snapshot');
            if(oldJson) {
                let oldSnapshot = JSON.parse(oldJson); let changesFound = [];
                for (const [key, newVal] of Object.entries(currentSnapshot)) {
                    let oldVal = oldSnapshot[key];
                    if(oldVal && oldVal !== newVal) {
                        let parts = key.split("-DRV"); let drvIdx = parseInt(parts[1]); let drvName = drivers.find(d => d.idx === drvIdx)?.name || "Collega";
                        let detailMsg = `<b>${drvName}</b> - ${parts[0]}<br><span style="font-size:0.85rem; color:var(--text-sec)">Da: <b>${oldVal}</b> &rarr; A: <b>${newVal}</b></span>`;
                        changesFound.push(detailMsg); notifHistory.unshift({ id: Date.now()+Math.random(), text: detailMsg, read: false, date: new Date().toLocaleString() });
                    }
                }
                if(changesFound.length > 0) { saveNotifications(); updateBadge(); showChangeAlert(changesFound); }
            }
            localStorage.setItem('nurse_schedule_snapshot', JSON.stringify(currentSnapshot));
        }
        function loadNotificationHistory() { let saved = localStorage.getItem('notifications_history_nurses'); if(saved) notifHistory = JSON.parse(saved); updateBadge(); }
        function saveNotifications() { localStorage.setItem('notifications_history_nurses', JSON.stringify(notifHistory)); }
        function updateBadge() { const c = notifHistory.filter(n => !n.read).length; const b = document.getElementById('notif-badge'); if(c > 0) b.classList.add('visible'); else b.classList.remove('visible'); }
        function openNotifCenter() { vibrate(); let modal = document.getElementById('notif-center-modal'); modal.style.display = 'flex'; setTimeout(() => modal.classList.add('open'), 10); renderNotifList(); setTimeout(() => { notifHistory.forEach(n => n.read = true); saveNotifications(); updateBadge(); }, 1000); }
        function closeNotifCenter() { let modal = document.getElementById('notif-center-modal'); modal.classList.remove('open'); setTimeout(() => modal.style.display = 'none', 300); }
        function renderNotifList() { const c = document.getElementById('notif-list-container'); c.innerHTML = ""; if(notifHistory.length===0) { c.innerHTML='<div class="no-notif">Nessuna notifica.</div>'; return; } notifHistory.forEach(item => { c.innerHTML += `<div class="notif-item ${item.read?'':'unread'}"><div class="notif-date">${item.date}</div><div class="notif-text">${item.text}</div><button class="btn-del-notif" onclick="deleteNotif(${item.id})"><span class="material-icons-round" style="font-size:18px">close</span></button></div>`; }); }
        function deleteNotif(id) { vibrate(); notifHistory = notifHistory.filter(n => n.id !== id); saveNotifications(); renderNotifList(); updateBadge(); }
        function clearAllNotif() { if(confirm("Eliminare tutto?")) { vibrate(); notifHistory = []; saveNotifications(); renderNotifList(); updateBadge(); } }
        function showChangeAlert(changes) { let msg = "Cambi turno:<br>" + changes.slice(0, 5).join("<br>"); document.getElementById('alert-message-text').innerHTML = msg; let m = document.getElementById('alert-modal'); m.style.display = 'flex'; setTimeout(() => m.classList.add('open'), 100); vibrate(); }
        function closeAlertAndSave() { vibrate(); let m = document.getElementById('alert-modal'); m.classList.remove('open'); setTimeout(() => m.style.display='none', 300); }

        function scrollToToday() { const el = document.getElementById('today-row'); if(el) { const offset = el.getBoundingClientRect().top - document.body.getBoundingClientRect().top - 160; window.scrollTo({ top: offset, behavior: "smooth" }); }}
        function filterDriver(val, btnEl) {
            vibrate(); if (val === 'all') selectedDrivers.clear(); else { const intVal = parseInt(val); if (selectedDrivers.has(intVal)) selectedDrivers.delete(intVal); else selectedDrivers.add(intVal); }
            localStorage.setItem("selected_nurses", JSON.stringify([...selectedDrivers])); updateDriverButtons(); renderTable();
        }
        function updateDriverButtons() { const allBtn = document.querySelector('.chip-driver[data-idx="all"]'); if(selectedDrivers.size === 0) allBtn.classList.add('active'); else allBtn.classList.remove('active'); document.querySelectorAll('.chip-driver:not([data-idx="all"])').forEach(btn => { const idx = parseInt(btn.dataset.idx); if(selectedDrivers.has(idx)) btn.classList.add('active'); else btn.classList.remove('active'); }); }
        function startLiveClock() { setInterval(() => { const now = new Date(); document.querySelectorAll('.live-clock').forEach(el => el.innerText = `${now.toLocaleDateString('it-IT',{weekday:'short',day:'numeric',month:'short'})} • ${now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}`); }, 1000); }

        function renderTable() {
            const thead = document.getElementById('table-head'); const tbody = document.getElementById('table-body'); const nav = document.getElementById('month-nav');
            thead.innerHTML = ""; tbody.innerHTML = ""; nav.innerHTML = "";
            let cols = (selectedDrivers.size === 0) ? drivers : drivers.filter(d => selectedDrivers.has(d.idx));
            let thD = document.createElement('th'); thD.innerText = "DATA"; thD.style.left = "0"; thD.style.zIndex="95"; thead.appendChild(thD);
            cols.forEach(d => { let th = document.createElement('th'); th.innerText = d.name; thead.appendChild(th); });

            let currentMonth = ""; let monthsFound = []; let year = 2026; const today = new Date();
            for(let i = 1; i < finalData.length; i++) {
                let row = finalData[i]; let mName = row[0].v; let dNum = parseInt(row[1].v);
                if(mName && mName !== currentMonth) { currentMonth = mName; let mId = "m-" + i; monthsFound.push({name: mName, id: mId}); tbody.innerHTML += `<tr class="month-header" id="${mId}"><td colspan="${cols.length + 1}"><div class="sticky-month-text"><span class="month-label">${mName}</span><span class="live-clock"></span></div></td></tr>`; }
                let tr = document.createElement('tr'); let mIdx = MONTH_MAP[currentMonth]; let dateObj = new Date(year, mIdx, dNum);
                let dayWeek = dateObj.toLocaleDateString('it-IT', { weekday: 'short' }).toUpperCase(); let dayIdx = dateObj.getDay(); 
                let holKey = `${mIdx}-${dNum}`; let holidayName = HOLIDAYS[holKey]; let isRed = (dayIdx === 0 || dayIdx === 6 || holidayName);
                let dateClass = isRed ? "td-date date-red" : "td-date";
                if(mIdx === today.getMonth() && dNum === today.getDate() && today.getFullYear() === year) { tr.className = "today"; tr.id = "today-row"; }
                tr.innerHTML = `<td class="${dateClass}">${dNum}<small>${dayWeek}</small>${holidayName ? `<div class="holiday-name">${holidayName}</div>` : ""}</td>`;
                cols.forEach(d => {
                    let cellInfo = row[d.idx]; let td = document.createElement('td'); td.innerHTML = formatCell(cellInfo);
                    let rawVal = cellInfo.v ? cellInfo.v.toString().trim().toUpperCase() : "";
                    if(rawVal || (cellInfo.subV && cellInfo.subV.toString().trim())) td.onclick = () => openShiftModal(i, rawVal, mName, dNum, dayWeek);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
            monthsFound.forEach(m => { let btn = document.createElement('div'); btn.className = "chip chip-month"; btn.innerText = m.name.substr(0,3); btn.onclick = () => { vibrate(); document.querySelectorAll('.chip-month').forEach(b => b.classList.remove('active')); btn.classList.add('active'); const el = document.getElementById(m.id); window.scrollTo({ top: el.getBoundingClientRect().top - document.body.getBoundingClientRect().top - 160, behavior: "smooth" }); }; nav.appendChild(btn); });
        }

        function formatCell(info) {
            let subVal = info.subV ? info.subV.toString().trim().toLowerCase() : "";
            if(subVal === "v") return `<div class="cell spec-ferie">FERIE<br>RESIDUE</div>`;
            if(subVal === "r") return `<div class="cell spec-rec">RECUPERO</div>`;
            if(subVal === "f") return `<div class="cell spec-cong">CONGEDO<br>ORD.</div>`;
            if(subVal === "m") return `<div class="cell spec-mal">MALATTIA</div>`;
            if(subVal === "nl") return `<div class="cell spec-nl">FESTIVO<br>NON LAV.</div>`;
            if(subVal === "p") return `<div class="cell spec-perm">PERMESSO</div>`;
            if(subVal === "ng") return `<div class="cell spec-ng">FESTIVO<br>NON GOD.</div>`;
            if(subVal === "c") return `<div class="cell spec-stu">PERMESSO<br>STUDIO</div>`;

            let val = info.v ? info.v.toString().trim() : ""; let u = val.toUpperCase();
            let time = SCHEDULE[u] ? `<div class="time-tag">${SCHEDULE[u]}</div>` : "";
            if(u === "M") return `<div class="cell t-M">MAT${time}</div>`;
            if(u === "P") return `<div class="cell t-P">POM${time}</div>`;
            if(u === "N") return `<div class="cell t-N">NOT${time}</div>`;
            if(u === "S") return `<div class="cell t-S">SM${time}</div>`;
            if(u === "R") return `<div class="cell t-R">RIP${time}</div>`;
            if(val === "-" || val === "") return `<div class="cell empty">-</div>`;
            return `<div class="cell">${u}</div>`;
        }

        function openShiftModal(rowIndex, shiftType, month, day, weekDay) {
            vibrate();
            let modal = document.getElementById('shift-modal'); let list = document.getElementById('modal-list');
            let content = document.querySelector('#shift-modal .modal-content');
            
            // Imposta Tema Colore Modale
            content.className = "modal-content"; 
            if(shiftType === "M") content.classList.add("modal-theme-M");
            else if(shiftType === "P") content.classList.add("modal-theme-P");
            else if(shiftType === "N") content.classList.add("modal-theme-N");
            else if(shiftType === "R") content.classList.add("modal-theme-R");
            else if(shiftType === "SM") content.classList.add("modal-theme-SM");

            let fullText = "TURNO"; let icon = "info";
            if(shiftType==="M") { fullText = "MATTINA"; icon="wb_sunny"; }
            else if(shiftType==="P") { fullText = "POMERIGGIO"; icon="wb_twilight"; }
            else if(shiftType==="N") { fullText = "NOTTE"; icon="bedtime"; }
            else if(shiftType==="R") { fullText = "RIPOSO"; icon="weekend"; }
            else if(shiftType==="SM") { fullText = "SMONTO"; icon="logout"; }
            
            document.getElementById('modal-title').innerHTML = `<span class="material-icons-round">${icon}</span> ${fullText}`;
            document.getElementById('modal-subtitle').innerText = `${weekDay} ${day} ${month}`;
            
            list.innerHTML = "";
            let rowData = finalData[rowIndex];
            let count = 0;

            drivers.forEach(d => {
                let cell = rowData[d.idx];
                let val = cell.v ? cell.v.toString().trim().toUpperCase() : "";
                let sub = cell.subV ? cell.subV.toString().trim().toLowerCase() : "";
                
                // Mostra il collega se:
                // 1. Ha lo stesso turno cliccato (es. entrambi M)
                // 2. Oppure se abbiamo cliccato su una casella non-turno (es. Ferie), mostriamo chi lavora (M, P, N)
                
                let isWorking = (val === "M" || val === "P" || val === "N" || val === "SM");
                let isMatch = (val === shiftType);
                
                // Se ho cliccato su M, P, N, SM -> Mostro solo chi ha lo stesso turno
                if(["M","P","N","SM"].includes(shiftType)) {
                    if(val === shiftType) {
                        count++;
                        let time = SCHEDULE[val] || val;
                        list.innerHTML += `<div class="colleague-item"><span class="c-name">${d.name}</span><span class="c-time">${time}</span></div>`;
                    }
                } else {
                    // Se ho cliccato su Ferie o Riposo o altro -> Mostro tutti quelli che lavorano quel giorno
                    if(isWorking) {
                        count++;
                        let time = SCHEDULE[val] || val;
                        let badge = `<span style="font-size:0.7rem; font-weight:bold; margin-left:5px; background:#eee; padding:2px 5px; border-radius:4px">${val}</span>`;
                        list.innerHTML += `<div class="colleague-item"><span class="c-name">${d.name} ${badge}</span><span class="c-time">${time}</span></div>`;
                    }
                }
            });

            if(count === 0) list.innerHTML = "<div style='padding:30px; text-align:center; color:var(--text-sec)'>Nessun collega in questo turno.</div>";
            modal.style.display = 'flex'; setTimeout(() => modal.classList.add('open'), 10);
        }

        function closeShiftModal(e) { if(e && e.target !== e.currentTarget) return; let m=document.getElementById('shift-modal'); m.classList.remove('open'); setTimeout(()=>m.style.display='none', 200); }
        
        /* FUNZIONI MODALI EXTRA (CENA/STATS) RIMASTE UGUALI MA FUNZIONANTI */
        function openDinnerModal() { toggleMenu(); let m = document.getElementById('dinner-modal'); m.style.display = 'flex'; setTimeout(() => m.classList.add('open'), 10); resetDinnerStep(); let ml = document.getElementById('dinner-month-list'); ml.innerHTML=""; Object.keys(MONTH_MAP).forEach(k=>{let c=document.createElement('div');c.className="chip chip-month";c.innerText=k.substr(0,3);c.onclick=()=>{vibrate();document.querySelectorAll('#dinner-month-list .chip-month').forEach(x=>x.classList.remove('active'));c.classList.add('active');dinnerSelectedMonth=k;};ml.appendChild(c);}); let dl = document.getElementById('dinner-driver-list'); if(dl.children.length===0){drivers.forEach(d=>{let l=document.createElement('label');l.className="dinner-check-item checked";l.innerHTML=`<input type="checkbox" value="${d.idx}" checked onchange="this.parentElement.classList.toggle('checked');vibrate()"><div class="dinner-check-icon"><span class="material-icons-round" style="font-size:14px">check</span></div>${d.name}`;dl.appendChild(l);});} }
        function setEventType(t,e){vibrate();eventType=t;document.querySelectorAll('.event-option').forEach(x=>x.classList.remove('active'));e.classList.add('active');}
        function toggleAllDrivers(){vibrate();let ck=document.querySelectorAll('#dinner-driver-list input');let all=Array.from(ck).every(c=>c.checked);ck.forEach(c=>{c.checked=!all;c.parentElement.classList.toggle('checked',!all);});}
        function resetDinnerStep(){document.getElementById('dinner-step-1').style.display='block';document.getElementById('dinner-step-2').style.display='none';}
        function closeDinnerModal(e){if(e&&e.target!==e.currentTarget)return;let m=document.getElementById('dinner-modal');m.classList.remove('open');setTimeout(()=>m.style.display='none',200);}
        function calculateDinner(){vibrate();if(!dinnerSelectedMonth)return alert("Seleziona mese");let s=[];document.querySelectorAll('#dinner-driver-list input:checked').forEach(x=>s.push(parseInt(x.value)));if(s.length===0)return alert("Seleziona colleghi");let res=[];for(let i=1;i<finalData.length;i++){let r=finalData[i];if(r[0].v!==dinnerSelectedMonth)continue;let d=r[1].v;let ok=0;let ko=[];s.forEach(idx=>{let v=r[idx].v?r[idx].v.toString().trim().toUpperCase():"";let sv=r[idx].subV?r[idx].subV.toString().trim().toLowerCase():"";let busy=false;if(v==="M"||v==="P"||v==="N"||sv==="m"||sv==="f")busy=true;if(eventType==="cena" && v!=="N" && v!=="P") busy=false; if(busy)ko.push(drivers.find(z=>z.idx===idx).name);else ok++;});res.push({day:d,score:ok,tot:s.length,mis:ko});}res.sort((a,b)=>b.score-a.score);let c=document.getElementById('dinner-results-container');c.innerHTML="";res.slice(0,10).forEach(x=>{c.innerHTML+=`<div class="dinner-result-card"><div class="d-res-header"><span class="d-res-date">${x.day} ${dinnerSelectedMonth}</span><span class="d-res-score">${x.score}/${x.tot}</span></div>${x.mis.length?`<div class="missing-list">${x.mis.map(n=>`<span class="missing-badge">${n}</span>`).join("")}</div>`:`<div style="color:green;font-weight:bold;text-align:center">TUTTI LIBERI!</div>`}</div>`});document.getElementById('dinner-step-1').style.display='none';document.getElementById('dinner-step-2').style.display='block';}

        function openStatsSelection(){toggleMenu();let c=document.getElementById('stats-container');c.innerHTML="";drivers.forEach(d=>{c.innerHTML+=`<div class="driver-list-item" onclick="showDriverStats(${d.idx},'${d.name}')"><span>${d.name}</span><span class="material-icons-round">chevron_right</span></div>`;});document.getElementById('stats-modal').classList.add('open');}
        function closeStatsModal(){document.getElementById('stats-modal').classList.remove('open');}
        function showDriverStats(idx,name){
            let s={M:0,P:0,N:0,R:0,F:0,MAL:0};
            for(let i=1;i<finalData.length;i++){let r=finalData[i][idx];let v=r.v?r.v.toString().toUpperCase():"";let sv=r.subV?r.subV.toString().toLowerCase():"";
            if(v==="M")s.M++;if(v==="P")s.P++;if(v==="N")s.N++;if(v==="R")s.R++;
            if(sv==="v"||sv==="f")s.F++;if(sv==="m")s.MAL++;}
            document.getElementById('stats-container').innerHTML=`<div class="driver-list-item" onclick="openStatsSelection()" style="background:transparent;border:none"><span style="display:flex;align-items:center;gap:10px"><span class="material-icons-round">arrow_back</span> ${name}</span></div>
            <div class="stats-grid"><div class="stat-card" style="color:var(--c-M)"><span class="stat-val">${s.M}</span><span class="stat-lbl">Mattine</span></div><div class="stat-card" style="color:var(--c-P)"><span class="stat-val">${s.P}</span><span class="stat-lbl">Pomeriggi</span></div><div class="stat-card" style="color:var(--c-N)"><span class="stat-val">${s.N}</span><span class="stat-lbl">Notti</span></div><div class="stat-card" style="color:var(--t-R);background:var(--c-R)"><span class="stat-val">${s.R}</span><span class="stat-lbl">Riposi</span></div><div class="stat-card" style="color:#d97706"><span class="stat-val">${s.F}</span><span class="stat-lbl">Ferie</span></div></div>`;
        }
    </script>
</body>
</html>